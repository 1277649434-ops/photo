<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教育卡片生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Microsoft YaHei';
            src: local('Microsoft YaHei'), local('PingFang SC');
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        /* --- 卡片基础样式 --- */
        .card-container {
            background: linear-gradient(180deg, #87CEEB 0%, rgb(87, 38, 125) 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }
        .custom-text-style {
            font-family: 'Microsoft YaHei', sans-serif;
            font-style: italic;
            font-weight: bold;
        }
        input[type="file"] { display: none; }

        /* --- 编辑器全屏模态框 --- */
        #editorModal {
            position: fixed; inset: 0; z-index: 100;
            background-color: #1a1a1a;
            display: none; flex-direction: column;
        }
        
        #step1-crop, #step2-annotate {
            flex: 1; display: none; flex-direction: column; overflow: hidden;
        }

        /* 标注画布容器 */
        #annotationContainer {
            flex: 1;
            position: relative;
            background-color: #333;
            overflow: auto; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px; 
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 20px 20px;
        }

        /* 实际操作台 */
        #workStage {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: inline-block; 
            line-height: 0; 
            transform-origin: center center;
            margin: auto;
        }

        #stageBg {
            display: block;
            pointer-events: none;
            max-width: 100%;
            max-height: 60vh; 
            object-fit: contain;
        }

        /* --- 交互元素 --- */
        .interactive-item {
            position: absolute;
            z-index: 10;
            cursor: grab;
            border: 1px dashed transparent; 
            touch-action: none;
            user-select: none;
            line-height: normal;
            box-sizing: border-box;
        }
        .interactive-item:active { cursor: grabbing; }
        
        /* 选中状态 */
        .interactive-item.selected {
            border-color: rgba(255, 255, 255, 0.9);
            background-color: rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        .interactive-item.box-type.selected {
            border-color: transparent;
            background-color: transparent;
        }

        .temp-drawing-shape {
            position: absolute;
            z-index: 20;
            pointer-events: none; 
        }

        /* --- 把手 --- */
        .handle {
            position: absolute;
            width: 24px; height: 24px;
            background: white; border-radius: 50%;
            display: none; 
            align-items: center; justify-content: center;
            font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 110; cursor: pointer; line-height: 24px;
        }
        
        .interactive-item.selected .handle { display: flex; }

        .handle-del { top: -12px; left: -12px; color: #ef4444; border: 2px solid #ef4444; }
        .handle-copy { top: -12px; right: -12px; color: #3b82f6; border: 2px solid #3b82f6; }
        .handle-resize { bottom: -12px; right: -12px; color: #22c55e; border: 2px solid #22c55e; cursor: nwse-resize; }
        .handle-rotate { top: -35px; left: 50%; margin-left: -12px; color: #f59e0b; border: 2px solid #f59e0b; cursor: grab; }
        .handle-move { bottom: -12px; left: -12px; color: #a855f7; border: 2px solid #a855f7; cursor: move; }

        /* 内容 */
        .item-content {
            width: 100%; height: 100%;
            pointer-events: none; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .interactive-item[data-type="text"] .item-content {
            pointer-events: auto; width: auto; height: auto; min-width: 50px;
        }

        /* --- 样式 --- */
        .custom-input-text {
            font-family: 'Microsoft YaHei', sans-serif;
            font-weight: bold; font-size: 32px; white-space: nowrap;
            -webkit-text-stroke: 6px white; paint-order: stroke fill;
            text-shadow: 0 2px 6px rgba(0,0,0,0.4);
            outline: none; padding: 4px; cursor: text; line-height: 1.2;
        }

        .sticker-text { font-size: 40px; line-height: 1; white-space: nowrap; }
        
        .shape-rect {
            width: 100%; height: 100%;
            border: 4px solid; border-radius: 12px; box-sizing: border-box;
        }
        .shape-fill-rect { width: 100%; height: 100%; border-radius: 12px; }
        
        .shape-exp {
            width: 100%; height: 100%;
            background-size: 100% 100%; background-repeat: no-repeat;
        }

        .shape-line {
            width: 100%; height: 100%;
            border-bottom: 6px solid;
            box-sizing: border-box; margin-top: -3px;
        }

        #drawOverlay {
            position: absolute; inset: 0; z-index: 50; cursor: crosshair; display: none;
        }

        .tool-active { background-color: #4b5563; border-color: #9ca3af; }
        
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #666; cursor: pointer; flex-shrink: 0;
        }
        .color-dot.active { border-color: white; transform: scale(1.2); box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        #resultModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .refresh-btn { opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
        .text-wrapper:focus-within .refresh-btn, .text-wrapper:hover .refresh-btn { opacity: 1; pointer-events: auto; }
        .refresh-btn:active { transform: scale(0.9); background-color: rgba(255,255,255,0.4); }

        .decor-icon {
            position: absolute; bottom: 10px; right: 10px; width: 80px; height: 80px;
            opacity: 0.3; pointer-events: none; z-index: 0;
            display: flex; gap: 5px; justify-content: flex-end; align-items: flex-end;
        }

        /* Cropper */
        .cropper-view-box { outline: 2px solid #3b82f6; }
        .cropper-point { opacity: 0.8; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4" onclick="deselectAllItems()">

    <!-- 顶部提示 -->
    <div class="mb-4 text-center text-gray-600 max-w-lg">
        <h1 class="text-2xl font-bold mb-1 text-gray-800">教育卡片生成器</h1>
        <p class="text-xs text-gray-500">点击图片进入编辑 | 任意剪裁 + 涂鸦合成</p>
    </div>

    <!-- 卡片主体 -->
    <div id="capture-area" class="card-container rounded-[2rem] shadow-2xl w-full max-w-[480px] relative flex flex-col p-5 sm:p-6 overflow-hidden mx-auto" onclick="event.stopPropagation()">
        <div class="wave-decor" style="position: absolute; top: 40%; left: -10%; width: 120%; height: 60%; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 70%); transform: rotate(-15deg); z-index: 0; pointer-events: none;"></div>

        <div class="content-layer flex flex-col h-full z-10 relative">
            <div class="glass-panel flex flex-col p-4 sm:p-5 mb-5 sm:mb-6">
                
                <!-- 右下角装饰 SVG -->
                <div class="decor-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
                </div>

                <!-- 顶部 Logo -->
                <div class="flex justify-between items-start mb-3 sm:mb-4 border-b border-white/10 pb-3 relative z-10">
                    <div class="relative group cursor-pointer mr-4 flex-shrink-0" onclick="startWorkflow('logoImg')">
                        <img id="logoImg" src="data:image/png;base64,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" alt="Logo">
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white text-xs rounded transition-all">替换</div>
                    </div>
                    <div class="flex space-x-1 pt-1">
                        <span class="text-yellow-400 text-lg">★</span>
                        <span class="text-yellow-400 text-lg">★</span>
                        <span class="text-yellow-400 text-lg">★</span>
                        <span class="text-yellow-400 text-lg">★</span>
                        <span class="text-yellow-400 text-lg">★</span>
                    </div>
                </div>

                <!-- 文字与主图 -->
                <div class="flex flex-col mb-3 sm:mb-4 relative z-10">
                    <div class="mb-3 sm:mb-4 relative text-wrapper group" tabindex="0">
                        <p id="mainText" contenteditable="true" 
                           class="custom-text-style text-xl sm:text-2xl leading-relaxed text-white p-2 border border-transparent hover:border-white/30 rounded transition-colors outline-none cursor-text drop-shadow-sm pr-8">
                           "双击文字可以编辑 ，每次都需要手动上传 logo，图片文字替换完成以后点击下载按钮下载，如果下载不了请切换浏览器，如 edge 等，"
                        </p>
                        <button onclick="changeQuote()" data-html2canvas-ignore="true" class="refresh-btn absolute bottom-2 right-2 p-1.5 rounded-full bg-white/20 hover:bg-white/40 text-white backdrop-blur-sm transition-all" title="换一句">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                    </div>

                    <div class="w-full relative group cursor-pointer overflow-hidden rounded-lg bg-black/10" onclick="startWorkflow('mainImg')">
                        <div class="w-full h-full flex items-center justify-center border-2 border-dashed border-white/30 hover:border-white/60 transition-all relative min-h-[200px] sm:min-h-[220px]">
                            <img id="mainImg" src="" class="w-full h-auto object-contain hidden" alt="主要图片">
                            <div id="mainImgPlaceholder" class="text-white/80 text-center py-10 px-4 absolute z-0 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full">
                                <svg class="w-10 h-10 mx-auto mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <p class="text-sm">点击上传并涂鸦</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部信息 -->
                <div class="flex items-center pt-3 border-t border-white/10 relative z-10">
                    <div class="relative cursor-pointer shrink-0" onclick="startWorkflow('avatarImg')">
                        <div id="avatarContainer" class="w-12 h-12 rounded-full bg-white/20 border border-white/40 overflow-hidden flex items-center justify-center shadow-inner backdrop-blur-md">
                            <img id="avatarImg" src="" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="ml-3 flex flex-col justify-center text-white">
                        <span contenteditable="true" class="text-base font-bold border-b border-transparent hover:border-white/50 outline-none leading-tight pb-0.5">家长姓名</span>
                        <span contenteditable="true" class="text-xs opacity-80 border-b border-transparent hover:border-white/50 outline-none mt-0.5">三年级二班</span>
                    </div>
                    <div class="ml-auto opacity-30 text-white text-3xl sm:text-4xl font-serif leading-none select-none">”</div>
                </div>
            </div>

            <div class="mt-auto text-center pb-2 pointer-events-auto">
                <h2 class="text-white text-xs sm:text-sm font-medium font-sans tracking-widest opacity-80 drop-shadow-md">做有温度的教育 &nbsp;&nbsp;&nbsp; 做有梦想的教育</h2>
            </div>
        </div>
    </div>

    <button onclick="downloadCard()" class="mt-6 mb-10 bg-slate-700 hover:bg-slate-800 text-white font-medium py-3 px-8 rounded-full shadow-lg transition-all hover:scale-105 active:scale-95 flex items-center gap-2 text-sm z-50">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
        生成并保存卡片
    </button>

    <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(this)">

    <!-- 全屏编辑器 -->
    <div id="editorModal" onclick="deselectAllItems()">
        <!-- 步骤1: 剪裁 -->
        <div id="step1-crop">
            <div class="bg-gray-900 p-4 text-white flex justify-between items-center z-20">
                <span class="font-bold text-lg">步骤1: 任意剪裁</span>
                <div>
                    <button onclick="closeEditor()" class="text-gray-400 mr-4">取消</button>
                    <button onclick="finishCrop()" class="bg-blue-600 px-4 py-1.5 rounded text-sm font-bold">下一步</button>
                </div>
            </div>
            <div class="flex-1 bg-black flex items-center justify-center overflow-hidden relative">
                <img id="cropTarget" class="max-w-full max-h-full block">
            </div>
        </div>

        <!-- 步骤2: 涂鸦标注 -->
        <div id="step2-annotate">
            <div class="bg-gray-900 p-2 text-white z-20 flex flex-col gap-2 shadow-lg" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2 px-2">
                    <span class="font-bold text-lg">步骤2: 涂鸦与标注</span>
                    <button onclick="finishAnnotation()" class="bg-green-600 px-6 py-1.5 rounded-full text-sm font-bold">完成并插入</button>
                </div>
                
                <!-- 贴纸栏 -->
                <div class="flex items-center gap-3 overflow-x-auto pb-1 px-2 no-scrollbar border-b border-gray-700 pb-2">
                    <span class="text-xs text-gray-400 whitespace-nowrap">贴纸:</span>
                    <button onclick="addSticker('💪')" class="text-2xl hover:bg-gray-700 rounded p-1">💪</button>
                    <button onclick="addSticker('👏')" class="text-2xl hover:bg-gray-700 rounded p-1">👏</button>
                    <button onclick="addSticker('😤')" class="text-2xl hover:bg-gray-700 rounded p-1">😤</button>
                    <button onclick="addSticker('🎁')" class="text-2xl hover:bg-gray-700 rounded p-1">🎁</button>
                    <button onclick="addSticker('🎉')" class="text-2xl hover:bg-gray-700 rounded p-1">🎉</button>
                    <button onclick="addSticker('🏆')" class="text-2xl hover:bg-gray-700 rounded p-1">🏆</button>
                    <button onclick="addSticker('🎊')" class="text-2xl hover:bg-gray-700 rounded p-1">🎊</button>
                    <button onclick="addSticker('😁')" class="text-2xl hover:bg-gray-700 rounded p-1">😁</button>
                </div>

                <!-- 颜色选择 -->
                <div class="flex items-center gap-3 px-2 py-1 overflow-x-auto no-scrollbar border-b border-gray-700 pb-2">
                    <span class="text-xs text-gray-400">颜色:</span>
                    <div class="color-dot active" style="background: #ef4444;" onclick="setColor('#ef4444', this)"></div> <!-- 红 -->
                    <div class="color-dot" style="background: #f97316;" onclick="setColor('#f97316', this)"></div> <!-- 橙 -->
                    <div class="color-dot" style="background: #eab308;" onclick="setColor('#eab308', this)"></div> <!-- 黄 -->
                    <div class="color-dot" style="background: #22c55e;" onclick="setColor('#22c55e', this)"></div> <!-- 绿 -->
                    <div class="color-dot" style="background: #3b82f6;" onclick="setColor('#3b82f6', this)"></div> <!-- 蓝 -->
                    <div class="color-dot" style="background: #a855f7;" onclick="setColor('#a855f7', this)"></div> <!-- 紫 -->
                    <div class="color-dot" style="background: #4C1D95;" onclick="setColor('#4C1D95', this)"></div> <!-- 深紫 -->
                    <div class="color-dot" style="background: #000000;" onclick="setColor('#000000', this)"></div> <!-- 黑 -->
                    <div class="color-dot" style="background: #ffffff;" onclick="setColor('#ffffff', this)"></div> <!-- 白 -->
                    <div class="color-dot" style="background: #D1D5DB;" onclick="setColor('#D1D5DB', this)"></div> <!-- 浅灰 -->
                </div>

                <!-- 工具栏 -->
                <div class="flex gap-2 px-2 overflow-x-auto pb-1">
                    <button id="btnText" onclick="addTextSticker()" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">T 文本</button>
                    <button id="btnRect" onclick="setDrawingMode('rect', this)" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">□ 空心</button>
                    <button id="btnFill" onclick="setDrawingMode('fillRect', this)" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">■ 色块</button>
                    <button id="btnLine" onclick="setDrawingMode('line', this)" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">➖ 直线</button>
                    <!-- 移除箭头按钮 -->
                    <button id="btnExp" onclick="setDrawingMode('explosion', this)" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">💥 爆炸</button>
                    <button onclick="undo()" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-gray-300 whitespace-nowrap">↩️ 撤销</button>
                    <button onclick="clearAllItems()" class="flex-1 border border-gray-600 rounded py-1.5 px-3 text-xs text-red-300 whitespace-nowrap">🗑️ 清空</button>
                </div>
            </div>

            <!-- 涂鸦画布 -->
            <div id="annotationContainer" onclick="deselectAllItems()">
                <div id="workStage" onclick="event.stopPropagation()">
                    <img id="stageBg" class="block">
                    <div id="drawOverlay"></div> <!-- 绘图层 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 结果预览 -->
    <div id="resultModal" onclick="this.style.display='none'">
        <div class="text-white text-center mb-4" onclick="event.stopPropagation()">
            <p class="text-lg font-bold">保存成功</p>
            <p class="text-sm opacity-80 mt-1">长按图片保存到手机</p>
        </div>
        <img id="resultImg" class="max-w-[90%] max-h-[80%] rounded-lg shadow-2xl border-2 border-white/20" onclick="event.stopPropagation()">
        <button onclick="this.parentElement.style.display='none'" class="mt-6 bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-full text-sm backdrop-blur-sm" onclick="event.stopPropagation()">关闭</button>
    </div>

    <script>
        // --- 变量 ---
        let cropper = null;
        let currentTargetId = '';
        let historyStack = [];
        let drawingMode = null; 
        let drawingColor = '#ef4444'; // 默认红色
        const quotes = ["每次付出都有意义，付出在哪里，收获就在哪里，时间会在你身上雕刻出努力的痕迹。",
"星光不问赶路人，时光不负有心人。你现在的每一分努力，都是在为未来的幸运埋下伏笔。",
"学习不仅仅是为了那一张试卷，而是为了让你拥有选择世界的权利，而不是被迫被世界选择。",
"曾国藩曾说：“结硬寨，打呆仗。”学习没有捷径，唯一的捷径就是一步一个脚印的踏实。",
"即使在最黑暗的泥土里，种子也在默默积蓄力量。你现在的沉默，是为了将来破土而出的惊艳。",
"那些看似不开窍的日子，其实是在扎根。竹子前四年只长几厘米，第五年却能每天生长三十厘米。",
"不要假装努力，结果不会陪你演戏。骗得过别人，骗不过深夜里焦虑的自己。",
"鲁迅先生说：“哪有什么天才，我只是把别人喝咖啡的工夫都用在了工作上。”把碎片时间利用起来，你就在超越。",
"既然选择了远方，便只顾风雨兼程。路漫漫其修远兮，吾将上下而求索。",
"当你想要放弃的时候，想一想当初为什么开始，想一想那些期待的眼神，和那个不甘平庸的自己。",
"所谓的黑马，不过是厚积薄发；所谓的逆袭，不过是有备而来。",
"只有极其努力，才能看起来毫不费力。优异的成绩背后，是无数个无人问津的日夜。",
"哈佛图书馆的训言：此刻打盹，你将做梦；此刻学习，你将圆梦。",
"这一秒不放弃，下一秒就有希望。坚持下去才可能发生奇迹，而不是看到了奇迹才去坚持。",
"无论黑夜多么漫长，白昼总会到来。你现在的迷茫和痛苦，都是黎明前最后的黑暗。",
"书山有路勤为径，学海无涯苦作舟。古人的智慧告诉我们，勤奋和刻苦是通往知识殿堂的唯一通行证。",
"你背不下来的书，总有人能背下来；你做不出来的题，总有人能做出来；你愿意拖到明天的事，总有人今天努力做完。",
"不要在那页读不懂的书上停留太久，继续往下读，时间会给你答案。学习也是如此，坚持下去，豁然开朗。",
"真正的强者，不是没有眼泪的人，而是含着眼泪依然奔跑的人。",
"种一棵树最好的时间是十年前，其次是现在。学习永远不嫌晚，只要你现在开始行动。",
"尼采说：“每一个不曾起舞的日子，都是对生命的辜负。”对于学生而言，每一个不曾努力学习的日子，都是对未来的辜负。",
"今天的晚睡，是为了明天的早起；今天的辛苦，是为了未来的自由。",
"将来的你，一定会感谢现在拼命努力的自己。",
"没有谁的运气是凭空而来的，只有当你足够努力，你才会足够幸运。这世界不会辜负每一份坚持和汗水。",
"你的对手在看书，你的仇人在磨刀，你的闺蜜在减肥，隔壁老王在练腰。你有什么理由不努力？",
"学习的痛苦是暂时的，未学到的痛苦是终身的。",
"只有耐得住寂寞，才能守得住繁华。在别人喧嚣的时候安静学习，你才能在别人沉默的时候发出声音。",
"宝剑锋从磨砺出，梅花香自苦寒来。不经一番寒彻骨，怎得梅花扑鼻香。",
"如果你觉得现在走得很辛苦，那就证明你在走上坡路。下坡路虽然舒服，但通向的是低谷。",
"所有的偷懒，最后都会变成打脸的巴掌。所有的努力，最后都会变成岁月的勋章。",
"海明威在《老人与海》中写道：“一个人可以被毁灭，但不能被打败。”在学习的战场上，你可以失败，但绝不能认输。",
"你的时间有限，所以不要为别人而活。不要被教条所限，不要活在别人的观念里。听从自己内心的声音，去追逐知识。",
"哪怕只有百分之一的希望，也要付出百分之百的努力。因为人生很多时候，不是看到了希望才坚持，而是坚持了才看到希望。",
"今天的汗水，是为了冲淡未来的泪水。",
"读书是为了让你遇见更好的自己，见到更广阔的世界，而不是为了某种功利的目的。",
"世界上最可怕的事是：比你优秀的人，比你还努力。",
"天才就是百分之九十九的汗水加百分之一的灵感。虽然灵感很重要，但没有那汗水，灵感永远不会降临。",
"任何值得去的地方，都没有捷径。一步一个脚印，才是最快的速度。",
"罗曼·罗兰说：“世界上只有一种英雄主义，那就是认清生活的真相后依然热爱生活。”学习的英雄主义，是认清学习的枯燥后依然热爱求知。",
"不积跬步，无以至千里；不积小流，无以成江海。每天一点点的进步，终将汇聚成成功的汪洋。",
"那些你熬夜努力的时光，那些你早起背诵的单词，终将成为你脚下的路，送你去想去的地方。",
"乾坤未定，你我皆是黑马。只要考试结束铃声未响，一切皆有可能。",
"学习就像长跑，最难的不是起跑，而是中途的坚持和最后的冲刺。咬紧牙关，你就是冠军。",
"你的气质里，藏着你读过的书和走过的路。",
"努力不是为了感动谁，也不是为了做给谁看，而是为了让自己随时有能力跳出自己厌恶的圈子，并拥有选择的权利。",
"凡是过往，皆为序章。无论过去成绩如何，从此刻开始努力，未来依然可期。",
"苏轼说：“古之立大事者，不惟有超世之才，亦必有坚忍不拔之志。”智商决定下限，毅力决定上限。",
"别让你的梦想，只停留在梦里。拿起笔，翻开书，这就是实现梦想的第一步。",
"我们可以平凡，但绝不能平庸。通过学习，我们可以让平凡的生命散发出不平凡的光彩。",
"只有登上山顶，才能看到那边的风光。在半山腰喊累的人，永远无法领略顶峰的景色。",
"你流下的每一滴汗水，都会浇灌出未来的花朵。",
"不要因为一次失败就否定自己，考试只是检测，不是判决。每一次跌倒，都是为了更好地站起来。",
"无论世界如何喧嚣，请在内心留一盏灯，照亮书桌，照亮前路。",
"既然目标是地平线，留给世界的只能是背影。",
"泰戈尔说：“只有流过血的手指，才能弹出世间的绝唱。”只有经过炼狱般的磨练，才能拥有创造天堂的力量。",
"你的负担将变成礼物，你受的苦将照亮你的路。",
"当你足够优秀时，你想要的一切都会来找你。现在的努力，是为了让未来的自己更有价值。",
"学习没有假期，梦想不打烊。",
"所谓的光辉岁月，并不是以后闪耀的日子，而是无人问津时，你对梦想的偏执。",
"人生没有白走的路，每一步都算数。你背过的每一个公式，做过的每一道题，都在铺就通往成功的阶梯。",
"只有拼尽全力，才有资格说运气不好。",
"你的潜力远比你想象的要大，不要轻易给自己设限。逼自己一把，你会发现自己有多优秀。",
"只有经受住考验，才能配得上梦想。",
"最慢的步伐不是跬步，而是徘徊；最快的脚步不是冲刺，而是坚持。",
"真正的努力，不是做给别人看的，而是为了让自己心安。",
"就算全世界都否定你，你也要相信自己。你生来就是为了高山而非溪流，为了群星而非野草。",
"每一本打开的书，都是一个等待被探索的世界。每一支写完的笔，都是一把斩断荆棘的利剑。",
"没有伞的孩子，必须努力奔跑。",
"只要路是对的，就不怕路远。",
"那些独自努力的时光，终会让你变成光。",
"成功不是将来才有的，而是从决定去做的那一刻起，持续累积而成的。",
"你现在的态度，决定你十年后的高度。",
"哪怕是一只蜗牛，只要坚持不懈，也能爬上金字塔的顶端。",
"任何时候开始都不晚，晚的是你从来都不敢开始。",
"学习虽然苦，但那是你看世界的路。",
"只有把细节做到极致，才能成就完美。学习中的每一个知识点，都是通往满分的基石。",
"能够耐得住寂寞的人，往往有着更远大的志向。",
"不为失败找借口，只为成功找方法。",
"与其临渊羡鱼，不如退而结网。羡慕别人的成绩，不如自己埋头苦读。",
"今天的努力，是明天最强的底气。",
"无论多难，由于坚持，一切都会变得容易。",
"生命不息，奋斗不止。学习是一辈子的事，不仅是为了学历，更是为了灵魂的丰盈。",
"做难事必有所得。那些让你感到痛苦的题目，正是你成长的契机。",
"不要因为也许会改变，就不肯说那句美丽的誓言；不要因为也许会分离，就不敢求一次倾心的相遇；不要因为也许会失败，就不肯付出那份真挚的努力。",
"高考/中考 是一场兵荒马乱的战争，而你就是那个统领千军万马的将军。",
"你必须非常努力，才能让人觉得你毫不费力。",
"把简单的招式练到极致就是绝招。把基础知识掌握得滚瓜烂熟，你就是学霸。",
"只要你不认输，就没有人能让你输。",
"未来的你，会感谢现在那个咬牙坚持的自己。",
"不想认命，就去拼命。",
"你的职责是平整土地，而非焦虑时光。你做三四月的事，在八九月自有答案。",
"成功路上并不拥挤，因为坚持的人不多。",
"能够控制自己时间的人，才能控制自己的人生。",
"每一个清晨，都是一个新的开始。不要带着昨天的遗憾醒来，要带着今天的目标出发。",
"哪怕跌倒一百次，也要第一百零一次站起来。",
"学习不是为了给别人看，而是为了丰富自己的内心。",
"只有不断奔跑，才能留在原地。在这个快速发展的时代，停滞就是倒退。",
"每一个优秀的人，都有一段沉默的时光。那段时光，是付出了很多努力，忍受了很多孤独和寂寞，不抱怨不诉苦，只有自己知道。",
"不要让未来的你，讨厌现在的自己。",
"你想要的，岁月都会给你。前提是，你得等得起，你得配得上。",
"锲而舍之，朽木不折；锲而不舍，金石可镂。荀子的教诲，至今振聋发聩。",
"努力不一定成功，但不努力一定很轻松？不，不努力的轻松是暂时的，未来的代价是沉重的。",
"别在最能吃苦的年纪，选择了安逸。",
"每一道做错的题，都是一个宝藏，它指出了你思维的漏洞。",
"只有当你把学习当成一种习惯，你才能真正体会到其中的乐趣。",
"真正的聪明，是用笨功夫。",
"哪怕微不足道，也要掷地有声。",
"现在的低头，是为了将来的抬头。",
"所有的逆袭，都是有备而来；所有的光芒，都需要时间才能被看到。",
"你的每一份努力，上帝都看在眼里，记在账上。",
"学习是反人性的，所以优秀的人永远是少数。",
"不去耕耘，不去播种，再肥的沃土也长不出庄稼；不去奋斗，不去创造，再美的青春也结不出硕果。",
"只要方向是对的，慢一点也没关系。",
"那些挑灯夜战的日子，终将照亮你前行的路。",
"我们终其一生，就是要摆脱他人的期待，找到真正的自己。而学习，是找到自己的最佳途径。",
"没有天生的学霸，只有不懈的努力。",
"你的努力，是为了让你在未来拥有更多拒绝的权利。",
"只有拼出来的美丽，没有等出来的辉煌。",
"无论成绩好坏，请保持一颗求知的心。",
"每天进步一点点，一年之后就是巨大的飞跃。1.01的365次方约等于37.8，0.99的365次方约等于0.03。",
"不要被假象迷惑，真实的进步往往是无声的。",
"只有你自己最清楚，你是否真的尽力了。",
"学习是通往自由的阶梯。",
"你的梦想，需要你的努力来买单。",
"每一个不甘平庸的灵魂，都值得被尊重。",
"就算头破血流，也要撞破南墙。",
"不要给自己的懒惰找借口。",
"所有的运气，都是实力的累积。",
"既然选择了远方，就不要怕风雨兼程。",
"你的对手比你强，还比你努力。",
"只有坚持到最后，才能看到彩虹。",
"学习不仅是获取知识，更是磨练意志。",
"每一个成功者都有一个开始。勇于开始，才能找到成功的路。",
"不要等待机会，而要创造机会。",
"只有不断的努力，才能填补天赋的差距。",
"你的未来，掌握在你自己手中。",
"只有经历过地狱般的磨练，才能练就创造天堂的力量。",
"既然活着，就要活出精彩。",
"学习是世界上最公平的事情，一分耕耘，一分收获。",
"不要让今天的懒惰，成为明天的遗憾。",
"只有努力，才能改变命运。",
"你的努力，终将得到回报。",
"每一个奋斗的日子，都值得纪念。",
"只有坚持，才能看到希望。",
"学习是一种信仰。",
"你的汗水，不会白流。",
"只有拼搏，才能赢得未来。",
"每一个梦想，都值得被灌溉。",
"只有努力，才能不负青春。",
"你的未来，由你定义。",
"哪怕只有万分之一的可能，也要做一万分的努力。",
"有志者，事竟成，破釜沉舟，百二秦关终属楚；苦心人，天不负，卧薪尝胆，三千越甲可吞吴。",
"人生最大的失败，不是跌倒，而是不敢奔跑。",
"今天的苦，是为了明天的甜。",
"只有当你足够强大，世界才会对你和颜悦色。",
"学习不仅仅是为了分数，更是为了拥有独立的思想。",
"你的努力，是你最坚实的铠甲。",
"只有不断挑战自己，才能超越自己。",
"每一个清晨的早起，都是对梦想的致敬。",
"不要羡慕别人的光芒，你自己也是一颗星星。",
"学习是最低门槛的高贵。",
"只有耐得住寂寞，才能拥抱繁华。",
"你的坚持，终将美好。",
"哪怕风雨兼程，也要向着阳光奔跑。",
"每一个不眠的夜晚，都是为了更耀眼的明天。",
"只有努力，才能让梦想照进现实。",
"你的付出，时间看得见。",
"只有不断攀登，才能看到更远的风景。",
"学习是一场马拉松，不是百米冲刺。",
"你的未来，藏在你的努力里。",
"只有拼尽全力，才能无怨无悔。",
"每一个微小的进步，都值得庆祝。",
"只有坚持，才能创造奇迹。",
"学习是改变命运的钥匙。",
"你的汗水，是成功的养料。",
"只有努力，才能不负韶华。",
"每一个梦想，都需要行动来支撑。",
"只有拼搏，才能赢得尊重。",
"学习是一种生活方式。",
"你的努力，终将闪光。",
"只有不断前行，才能抵达彼岸。",
"每一个挑战，都是成长的机会。",
"只有坚持，才能看到胜利的曙光。",
"学习是为了更好的选择。",
"你的付出，终会有回报。",
"只有努力，才能改变现状。",
"每一个奋斗的身影，都是最美的风景。",
"只有拼搏，才能书写辉煌。",
"学习是提升自我价值的途径。",
"你的努力，是为了遇见更好的自己。",
"只要心中有光，脚下就有路。",
"没有什么比努力更能让人心安理得。",
"昨天的太阳，晒不干今天的衣裳；过往的辉煌，代表不了现在的成就。",
"你的脑子里有多少才华，你的步伐里就有多少自信。",
"真正能让你倒下的，不是对手，而是你自己的绝望。",
"不要在该奋斗的年纪选择安逸，否则你将在该安逸的年纪被迫奋斗。",
"即使是咸鱼，也要做最咸的那一条；即使是草根，也要做最坚韧的那一株。",
"风雨过后，不一定有彩虹，但一定会放晴。努力过后，不一定成功，但一定会有收获。",
"所有的光鲜亮丽，背后都是惨不忍睹的坚持。",
"你多学一样本事，就少说一句求人的话。",
"读书不苦，不读书的人生才苦。",
"无论你现在处于什么位置，只要你肯努力，你总能向上走。",
"你的努力，是为了让爱你的人骄傲，让你爱的人幸福。",
"没有谁的青春是容易的，只有当你咬牙坚持，青春才会发出光芒。",
"只有把书读进骨子里，才能吐出芬芳的灵魂。",
"你的成绩，是对你过去一段时间努力的最好反馈。",
"不要害怕走弯路，弯路也是路，而且沿途的风景更独特。",
"每一个优秀的人，都有一段“置之死地而后生”的经历。",
"只有你自己，才能拯救你自己。",
"学习是唯一一件只要付出就有回报的事情，虽然回报的周期可能有点长。",
"你的努力，是为了让你在面对世界时，更有底气。",
"只有不断学习，才能不被时代抛弃。",
"每一个梦想都值得呵护，每一份努力都值得尊重。",
"只有坚持到底，才能笑到最后。",
"学习是为了让你看到更大的世界，而不是为了把你困在书本里。",
"你的汗水，会变成你皇冠上的宝石。",
"只有拼尽全力，才能不留遗憾。",
"每一个日夜的奋斗，都是为了心中的那座灯塔。",
"只有努力，才能让你配得上你的野心。",
"学习是成长的必经之路。",
"你的未来，由你现在的每一个选择决定。",
"只有不断突破，才能看到新的风景。",
"每一个困难，都是包装后的礼物。",
"只有坚持，才能让梦想开花结果。",
"学习是为了让你拥有更广阔的视野。",
"你的努力，终将成就你的辉煌。",
"只有拼搏，才能赢得未来。",
"每一个奋斗的瞬间，都值得铭记。",
"只有努力，才能不负众望。",
"学习是提升能力的阶梯。",
"你的付出，是成功的基石。",
"只有不断前行，才能到达理想的彼岸。",
"每一个梦想，都需要汗水来浇灌。",
"只有坚持，才能看到成功的希望。",
"学习是为了让你拥有更多的可能性。",
"你的努力，是为了让你活成自己想要的样子。",
"只有拼搏，才能改变命运。",
"每一个不屈的灵魂，都值得歌颂。",
"只有努力，才能创造属于自己的奇迹。",
"学习是通往智慧的桥梁。",
"你的汗水，是青春最美的注脚。",
"只有坚持，才能让生命绽放光彩。",
"每一个梦想，都值得为之奋斗。",
"只有努力，才能不负此生。",
"学习是为了让你成为一个有温度、懂情趣、会思考的人。",
"你的未来，不是梦。",
"只有拼搏，才能赢得掌声。",
"每一个奋斗的日子，都将成为美好的回忆。",
"只有努力，才能让自己无可替代。",
"那些看似波澜不惊的日复一日，会在某一天，让你看到坚持的意义。",
"所有的好运，都是你积攒的人品和努力。",
"唯有成为更好的自己，世界才是你的。",
"你无法决定明天的太阳几点升起，但你可以决定几点起床。",
"只有把你逼到绝境，你才知道自己有多大潜能。",
"你的每一次专注，都在为你的大脑构建更强的神经网络。",
"那些看不见的光影，听不见的声响，都在你伏案苦读的瞬间，化作了力量。",
"真正的自由，是自律给的。",
"不要因为一次挫折就放弃整个人生，你的人生才刚刚开始。",
"你的每一个知识盲点，都是你未来的绊脚石。现在消灭它！",
"只有耐得住寂寞，才能守得住长远。",
"学习不仅仅是输入，更是输出。把学到的知识讲出来，才是真正的掌握。",
"你的书桌，就是你的战场。",
"只有不断反思，才能不断进步。",
"每一个错误，都是通往正确的路标。",
"只有专注于当下，才能赢得未来。",
"学习是为了让你在面对困难时，有更多的解决方案。",
"你的努力，是为了让你在未来拥有说“不”的底气。",
"只有坚持学习，才能保持年轻的心态。",
"每一个知识点，都是打开新世界的钥匙。",
"只有不断积累，才能厚积薄发。",
"学习是一种享受，享受获取知识的快感。",
"你的努力，是为了让你的人生少一些遗憾。",
"只有拼搏，才能让自己的人生更加精彩。",
"每一个梦想，都需要脚踏实地的努力。",
"只有坚持，才能让自己变得更加强大。",
"学习是为了让你看清世界的真相。",
"你的付出，终将得到岁月的馈赠。",
"只有努力，才能让自己的人生不设限。",
"每一个奋斗的足迹，都是成长的证明。",
"只有拼搏，才能让自己的人生没有白活。",
"学习是终身的事业。",
"你的努力，是为了让你拥有更高级的快乐。",
"只有坚持，才能让自己的人生更加充实。",
"每一个梦想，都值得用一生去追求。",
"只有努力，才能让自己的人生闪闪发光。",
"学习是为了让你成为那个不可或缺的人。",
"你的付出，是为了让你在未来能够保护你想保护的人。",
"只有拼搏，才能让自己的人生无悔。",
"每一个奋斗的日夜，都是生命中最美的乐章。",
"只有努力，才能让自己的人生充满希望。",
"那些被嘲笑的梦想，才有实现的价值。",
"不要总看别人光鲜亮丽，要看别人背后付出的艰辛。",
"你的每一分努力，都是在为你的未来增加筹码。",
"只有当你的才华撑得起你的野心时，你才能由着性子做自己。",
"学习，是让你从平庸走向卓越的最短路径。",
"愿你以梦为马，不负韶华。",
"愿你在合上笔盖的那一刻，有着战士收刀入鞘的骄傲。",
"愿你的努力，配得上你的梦想；愿你的付出，终有回报。",
"愿你出走半生，归来仍是少年；愿你历经千帆，终能得偿所愿。",
"加油，奋斗的你，未来可期！",
"读书破万卷，下笔如有神。知识是力量的源泉。",
"不要在该努力的年纪选择安逸，因为未来的你会为现在的懒惰买单。",
"与其抱怨黑暗，不如点亮蜡烛。学习是点亮人生的火种。",
"成功的路上并不拥挤，因为坚持的人太少。",
"哪怕起点再低，只要不停止前进，终将到达终点。",
"学习如逆水行舟，不进则退。",
"不要让别人的评价定义你的人生，你的实力才是最好的反击。",
"每一次跌倒，都是为了跳得更高。",
"只有经历了风雨，才能见到彩虹的美丽。",
"不要轻言放弃，否则对不起自己曾经的努力。",
"时间是公平的，它给每个人的一天都是24小时。",
"把每一天都当成生命中的最后一天来过，你会发现时间如此宝贵。",
"不要等到明天，明天还有明天的事。",
"现在的辛苦，是为了以后能有更多的选择。",
"只要心怀梦想，哪里都是舞台。",
"学习是世界上回报率最高的投资。",
"不要羡慕别人的天赋，努力才是你的天赋。",
"只有不断超越自己，才能成为更好的自己。",
"每一次考试，都是一次成长的机会。",
"不要因为一时的失败而气馁，失败是成功之母。",
"相信自己，你比想象中更强大。",
"只有脚踏实地，才能仰望星空。",
"梦想不只是说说而已，更要付诸行动。",
"不要让懒惰成为你成功的绊脚石。",
"只有坚持不懈，才能滴水穿石。",
"学习是孤独的旅程，但终点是繁华的世界。",
"不要害怕困难，困难是成长的垫脚石。",
"每一次努力，都在为未来积蓄力量。",
"只有心无旁骛，才能专注致远。",
"不要被眼前的利益迷惑，目光要放长远。",
"只有不断学习，才能跟上时代的步伐。",
"每一次进步，都值得给自己一个掌声。",
"不要在意别人的眼光，走自己的路。",
"只有相信奇迹，才能创造奇迹。",
"学习是改变命运的唯一捷径。",
"不要让后悔成为你人生的主旋律。",
"只有拼搏过的人生，才没有遗憾。",
"每一次挑战，都是一次自我突破。",
"不要满足于现状，要勇于追求卓越。",
"只有不断尝试，才能找到适合自己的路。",
"学习是通往成功的必经之路。",
"不要被挫折打败，站起来继续前行。",
"只有坚持到底，才能看到胜利的曙光。",
"每一次付出，都会有回报，只是时间早晚。",
"不要轻视微小的进步，积少成多。",
"只有心怀感恩，才能走得更远。",
"学习是灵魂的升华。",
"不要让借口阻挡你前进的脚步。",
"只有勇敢面对，才能战胜恐惧。",
"每一次思考，都是智慧的火花。",
"不要随波逐流，要有自己的主见。",
"只有不断创新，才能立于不败之地。",
"学习是永无止境的旅程。",
"不要被安逸消磨了斗志。",
"只有时刻准备着，才能抓住机会。",
"每一次选择，都决定了未来的方向。",
"不要忘记初心，方得始终。",
"只有心怀梦想，人生才有意义。",
"学习是开启智慧之门的钥匙。",
"不要让焦虑吞噬你的信心。",
"只有调整心态，才能从容面对。",
"每一次反思，都是为了更好地出发。",
"不要盲目攀比，做最好的自己。",
"只有脚踏实地，才能行稳致远。",
"学习是人生最宝贵的财富。",
"不要让拖延症毁了你的未来。",
"只有立即行动，才能产生结果。",
"每一次坚持，都是对梦想的守护。",
"不要害怕孤独，强者都是孤独的。",
"只有耐得住寂寞，才能守得住繁华。",
"学习是提升气质的最佳途径。",
"不要让消极情绪影响你的判断。",
"只有保持乐观，才能战胜困难。",
"每一次阅读，都是与智者的对话。",
"不要停止探索的脚步，世界很大。",
"只有不断求知，才能丰富内心。",
"学习是让人变得自信的源泉。",
"不要被失败定义，你还有无限可能。",
"只有永不言弃，才能获得成功。",
"每一次历练，都是生命的馈赠。",
"不要让平庸成为你的标签。",
"只有追求卓越，才能成就非凡。",
"学习是通往幸福的桥梁。",
"不要让借口成为你逃避的理由。",
"只有勇敢承担，才能成熟长大。",
"每一次尝试，都是一次新的开始。",
"不要害怕犯错，错误是成长的代价。",
"只有吸取教训，才能避免重蹈覆辙。",
"学习是让人保持年轻的秘诀。",
"不要被岁月磨平了棱角。",
"只有保持锋芒，才能披荆斩棘。",
"每一次突破，都是一次自我升华。",
"不要满足于当下的成就，前方还有更高峰。",
"只有不断攀登，才能领略更美的风景。",
"学习是让人内心强大的力量。",
"不要被外界的噪音干扰，听从内心的声音。",
"只有专注自我，才能成就自我。",
"每一次沉淀，都是为了更好地爆发。",
"不要急于求成，欲速则不达。",
"只有稳扎稳打，才能步步为营。",
"学习是让人看清世界本质的眼镜。",
"不要被表象迷惑，透过现象看本质。",
"只有深入思考，才能洞察真理。",
"每一次感悟，都是心灵的洗礼。",
"不要让浮躁蒙蔽了双眼。",
"只有静下心来，才能感悟人生。",
"学习是让人获得尊重的资本。",
"不要轻视知识的力量。",
"只有拥有知识，才能改变命运。",
"每一次分享，都是知识的传递。",
"不要吝啬你的知识，赠人玫瑰手有余香。",
"只有共同进步，才能走得更远。",
"学习是让人拥有独立人格的基石。",
"不要依附于他人，要做自己的主人。",
"只有独立自主，才能活出精彩。",
"每一次抉择，都是人生的转折点。",
"不要犹豫不决，机会稍纵即逝。",
"只有果断出击，才能把握命运。",
"学习是让人拥有广阔胸怀的途径。",
"不要斤斤计较，要有容人之量。",
"只有心胸宽广，才能纳百川。",
"每一次包容，都是一种修养。",
"不要让仇恨蒙蔽了心灵。",
"只有学会宽恕，才能解脱自己。",
"学习是让人懂得感恩的源泉。",
"不要理所当然，要心存感激。",
"只有懂得感恩，才能获得更多。",
"每一次回馈，都是爱的传递。",
"不要忘记帮助过你的人。",
"只有知恩图报，才能得道多助。",
"学习是让人拥有责任感的动力。",
"不要推卸责任，要勇于担当。",
"只有尽职尽责，才能赢得信任。",
"每一次承诺，都是信誉的保证。",
"不要轻许诺言，言必信行必果。",
"只有诚实守信，才能立足社会。",
"学习是让人拥有梦想的翅膀。",
"不要折断你的翅膀，要勇敢飞翔。",
"只有心怀梦想，才能飞得更高。",
"每一次翱翔，都是对自由的向往。",
"不要被笼子束缚，天空才是你的极限。",
"只有冲破束缚，才能获得自由。",
"学习是让人拥有创造力的源泉。",
"不要墨守成规，要敢于创新。",
"只有不断创新，才能引领潮流。",
"每一次发明，都是智慧的结晶。",
"不要害怕失败，失败是成功之母。",
"只有坚持不懈，才能取得成功。",
"学习是让人拥有领导力的基石。",
"不要只顾自己，要懂得带领团队。",
"只有团结协作，才能共创辉煌。",
"每一次合作，都是力量的汇聚。",
"不要孤军奋战，要懂得借力。",
"只有集思广益，才能解决难题。",
"学习是让人拥有执行力的关键。",
"不要纸上谈兵，要付诸实践。",
"只有行动起来，才能实现目标。",
"每一次实践，都是检验真理的标准。",
"不要害怕困难，迎难而上。",
"只有克服困难，才能获得成长。",
"学习是让人拥有适应力的法宝。",
"不要抱怨环境，要适应环境。",
"只有适者生存，才能立于不败。",
"每一次改变，都是为了生存。",
"不要拒绝变化，拥抱变化。",
"只有与时俱进，才能不被淘汰。",
"学习是让人拥有抗压力的盾牌。",
"不要被压力压垮，要变压力为动力。",
"只有承受压力，才能变得强大。",
"每一次挫折，都是一次磨练。",
"不要轻易低头，要昂首挺胸。",
"只有坚强不屈，才能战胜挫折。",
"学习是让人拥有洞察力的望远镜。",
"不要目光短浅，要高瞻远瞩。",
"只有看得更远，才能走得更稳。",
"每一次规划，都是为了未来。",
"不要盲目行动，要谋定而后动。",
"只有运筹帷幄，才能决胜千里。",
"学习是让人拥有沟通力的桥梁。",
"不要封闭自己，要学会沟通。",
"只有有效沟通，才能消除误解。",
"每一次交流，都是心灵的碰撞。",
"不要吝啬语言，要善于表达。",
"只有表达清晰，才能让人理解。",
"学习是让人拥有审美力的眼睛。",
"不要忽略美，要发现美。",
"只有懂得欣赏，才能享受生活。",
"每一次感动，都是美的洗礼。",
"不要麻木不仁，要保持敏感。",
"只有用心感受，才能体会美好。",
"学习是让人拥有健康力的基石。",
"不要透支身体，要保持健康。",
"只有身体健康，才能拥有一切。",
"每一次锻炼，都是对生命的投资。",
"不要懒惰不动，要积极运动。",
"只有充满活力，才能创造价值。",
"学习是让人拥有幸福力的源泉。",
"不要追求虚无，要追求真实。",
"只有内心满足，才能获得幸福。",
"每一次微笑，都是幸福的流露。",
"不要愁眉苦脸，要笑对人生。",
"只有保持快乐，才能感染他人。",
"学习是让人拥有爱力的种子。",
"不要吝啬爱，要学会爱。",
"只有付出爱，才能收获爱。",
"每一次关怀，都是爱的体现。",
"不要冷漠无情，要温暖待人。",
"只有充满爱心，世界才会美好。",
"学习是让人拥有和平力的鸽子。",
"不要制造冲突，要维护和平。",
"只有和谐相处，才能共生共荣。",
"每一次让步，都是为了大局。",
"不要斤斤计较，要懂得妥协。",
"只有相互尊重，才能赢得和平。",
"学习是让人拥有未来力的飞船。",
"不要停留在过去，要面向未来。",
"只有掌握未来，才能掌握命运。",
"每一次探索，都是为了未知。",
"不要害怕未知，要充满好奇。",
"只有不断探索，才能发现新大陆。",
"学习是让人拥有无限可能的魔法。",
"不要给自己设限，你就是奇迹。",
"只有相信自己，才能创造奇迹。",
"每一次超越，都是对极限的挑战。",
"不要停下脚步，前方风景独好。",
"只有不断前行，才能遇见更好的自己。",
"学习是你一生的朋友，请善待它。",
"不要抛弃学习，它会伴你终生。",
"只有终身学习，才能永葆青春。",
"每一次翻开书本，都是一次新生。",
"不要让书本蒙尘，让知识流动。",
"只有知识流动，才能产生价值。",
"学习是你最忠实的伙伴，不离不弃。",
"不要背叛学习，它会给你回报。",
"只有忠诚于学习，才能获得智慧。",
"每一次思考，都是与未来的对话。",
"不要停止思考，思考是人类的尊严。",
"只有独立思考，才能拥有自由的灵魂。",
"学习是你通往成功的阶梯，一步一个脚印。",
"不要想着一步登天，脚踏实地最重要。",
"只有坚持不懈，才能登上顶峰。",
"每一次努力，都是对生命的礼赞。",
"不要辜负生命，让生命绽放光彩。",
"只有活出自我，才不枉此生。",
"学习是你人生最美的风景，请细细品味。"];

        window.onload = () => {
            document.getElementById('mainText').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
            setRandomAvatar();
        };

        function setRandomAvatar() {
            const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#aaddaa"/><path d="M50 20 Q30 40 50 60 Q70 40 50 20 M50 60 L50 80 M40 70 L60 70" stroke="#558855" stroke-width="4" fill="none"/></svg>';
            const img = new Image();
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
            img.onload = () => {
                const c = document.createElement('canvas'); c.width=100; c.height=100;
                c.getContext('2d').drawImage(img,0,0);
                document.getElementById('avatarImg').src = c.toDataURL('image/png');
            }
        }

        // --- 流程控制 ---
        function startWorkflow(targetId) {
            currentTargetId = targetId;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => openEditor(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openEditor(src) {
            document.getElementById('editorModal').style.display = 'flex';
            document.getElementById('step1-crop').style.display = 'flex';
            document.getElementById('step2-annotate').style.display = 'none';
            
            const img = document.getElementById('cropTarget');
            img.src = src;
            if (cropper) cropper.destroy();
            
            cropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 0.9,
                cropBoxMovable: true, cropBoxResizable: true,
                toggleDragModeOnDblclick: false
            });
        }

        function finishCrop() {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048 });
            const url = canvas.toDataURL('image/jpeg');
            
            document.getElementById('step1-crop').style.display = 'none';
            document.getElementById('step2-annotate').style.display = 'flex';
            
            const bg = document.getElementById('stageBg');
            bg.src = url;
            
            // 清理上一轮涂鸦
            const stage = document.getElementById('workStage');
            Array.from(stage.children).forEach(child => {
                if(child.id !== 'stageBg' && child.id !== 'drawOverlay') child.remove();
            });
            historyStack = [];
            setDrawingMode(null, null);
            
            if (cropper) { cropper.destroy(); cropper = null; }
        }

        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
        }

        // --- 贴纸/标注逻辑 ---
        function deselectAllItems() {
            document.querySelectorAll('.interactive-item').forEach(el => el.classList.remove('selected'));
        }

        function setColor(color, btn) {
            drawingColor = color;
            document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            const selected = document.querySelector('.interactive-item.selected');
            if(selected) {
                const text = selected.querySelector('.custom-input-text');
                if(text) text.style.color = color;
                
                const rect = selected.querySelector('.shape-rect');
                if(rect) rect.style.borderColor = color;
                
                const fillRect = selected.querySelector('.shape-fill-rect');
                if(fillRect) fillRect.style.backgroundColor = color;
                
                const line = selected.querySelector('.shape-line');
                if(line) line.style.borderBottomColor = color;

                const exp = selected.querySelector('.shape-exp');
                if(exp) {
                    const encoded = encodeURIComponent(color);
                    exp.style.backgroundImage = `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 150' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10,75 L30,60 L20,40 L50,45 L60,20 L80,40 L100,10 L120,40 L140,20 L150,45 L180,40 L170,60 L190,75 L170,90 L180,110 L150,105 L140,130 L120,110 L100,140 L80,110 L60,130 L50,105 L20,110 L30,90 Z' fill='none' stroke='${encoded}' stroke-width='4' stroke-linejoin='round'/%3E%3C/svg%3E")`;
                }
            }
        }

        function changeQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const mainText = document.getElementById('mainText');
            mainText.innerText = `"${quotes[randomIndex]}"`;
        }

        // 创建交互元素工厂
        function createItem(contentNode, type='shape') {
            deselectAllItems();
            const el = document.createElement('div');
            el.className = type === 'shape' ? 'interactive-item selected box-type' : 'interactive-item selected';
            el.dataset.type = type; 
            el.style.left = '30%'; el.style.top = '30%';

            // 统一添加按钮
            const delBtn = document.createElement('div');
            delBtn.className = 'handle handle-del'; delBtn.innerText = '✕';
            delBtn.onclick = (e) => { e.stopPropagation(); el.remove(); if(drawingMode) setDrawingMode(null, null); };

            const copyBtn = document.createElement('div');
            copyBtn.className = 'handle handle-copy'; copyBtn.innerText = '❐';
            copyBtn.onclick = (e) => { 
                e.stopPropagation(); 
                duplicateItem(el); 
                if(drawingMode) setDrawingMode(null, null);
            };

            const resizeBtn = document.createElement('div');
            resizeBtn.className = 'handle handle-resize'; resizeBtn.innerText = '↘';

            const rotateBtn = document.createElement('div');
            rotateBtn.className = 'handle handle-rotate'; rotateBtn.innerText = '↻';

            const moveBtn = document.createElement('div');
            moveBtn.className = 'handle handle-move'; moveBtn.innerText = '✥';

            el.appendChild(delBtn);
            el.appendChild(copyBtn);
            el.appendChild(resizeBtn);
            el.appendChild(rotateBtn);
            el.appendChild(moveBtn);
            el.appendChild(contentNode);

            // 绑定交互 (传入 moveBtn)
            bindInteraction(el, resizeBtn, rotateBtn, moveBtn);

            // 点击选中
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                if(drawingMode) setDrawingMode(null, null);
                deselectAllItems();
                el.classList.add('selected');
            });
            
            el.addEventListener('dblclick', (e) => { e.stopPropagation(); el.remove(); });

            document.getElementById('workStage').appendChild(el);
            historyStack.push(el);
            return el;
        }

        function duplicateItem(original) {
            const clone = original.cloneNode(true);
            clone.style.left = (parseFloat(original.style.left) + 20) + 'px';
            clone.style.top = (parseFloat(original.style.top) + 20) + 'px';
            
            const resizeBtn = clone.querySelector('.handle-resize');
            const delBtn = clone.querySelector('.handle-del');
            const copyBtn = clone.querySelector('.handle-copy');
            const rotateBtn = clone.querySelector('.handle-rotate');
            const moveBtn = clone.querySelector('.handle-move');
            
            delBtn.onclick = (e) => { e.stopPropagation(); clone.remove(); };
            copyBtn.onclick = (e) => { e.stopPropagation(); duplicateItem(clone); };
            
            const input = clone.querySelector('.custom-input-text');
            if(input) {
                input.onclick = (e) => { e.stopPropagation(); deselectAllItems(); clone.classList.add('selected'); };
                input.onmousedown = (e) => e.stopPropagation();
                input.ontouchstart = (e) => e.stopPropagation();
            }

            bindInteraction(clone, resizeBtn, rotateBtn, moveBtn);
            
            clone.addEventListener('click', (e) => {
                e.stopPropagation(); 
                if(drawingMode) setDrawingMode(null, null);
                deselectAllItems(); 
                clone.classList.add('selected');
            });
            clone.addEventListener('dblclick', (e) => { e.stopPropagation(); clone.remove(); });

            document.getElementById('workStage').appendChild(clone);
            historyStack.push(clone);
            deselectAllItems(); clone.classList.add('selected');
        }

        function addTextSticker() {
            setDrawingMode(null, null); 
            const content = document.createElement('div');
            content.className = 'item-content';
            
            const input = document.createElement('div');
            input.contentEditable = true;
            input.className = 'custom-input-text';
            input.innerText = '点击输入';
            input.style.color = drawingColor;
            
            input.onmousedown = (e) => e.stopPropagation();
            input.ontouchstart = (e) => e.stopPropagation();
            input.onclick = (e) => { e.stopPropagation(); deselectAllItems(); input.closest('.interactive-item').classList.add('selected'); };
            
            content.appendChild(input);
            createItem(content, 'text');
        }

        function addSticker(text) {
            setDrawingMode(null, null);
            const content = document.createElement('div');
            content.className = 'item-content sticker-text';
            content.innerText = text;
            createItem(content, 'sticker');
        }

        // 交互逻辑 (拖拽 + 缩放 + 旋转)
        function bindInteraction(el, resizeHandle, rotateHandle, moveHandle) {
            // 绑定拖拽到主体 和 移动抓手
            el.addEventListener('touchstart', dragStart);
            el.addEventListener('mousedown', dragStart);
            if(moveHandle) {
                moveHandle.addEventListener('touchstart', dragStart);
                moveHandle.addEventListener('mousedown', dragStart);
            }

            function dragStart(e) {
                if(e.target.isContentEditable) return;
                // 如果点击的是其他功能按钮，不触发拖拽
                if(e.target.classList.contains('handle') && !e.target.classList.contains('handle-move')) return;
                
                e.preventDefault(); e.stopPropagation();
                if(drawingMode) setDrawingMode(null, null);
                deselectAllItems(); el.classList.add('selected');

                const p = e.touches ? e.touches[0] : e;
                const startX = p.clientX; const startY = p.clientY;
                const parentRect = el.parentElement.getBoundingClientRect();
                const offsetX = startX - el.getBoundingClientRect().left;
                const offsetY = startY - el.getBoundingClientRect().top;

                const move = (em) => {
                    const pm = em.touches ? em.touches[0] : em;
                    el.style.left = (pm.clientX - parentRect.left - offsetX) + 'px';
                    el.style.top = (pm.clientY - parentRect.top - offsetY) + 'px';
                };
                const up = () => {
                    window.removeEventListener('mousemove', move);
                    window.removeEventListener('touchmove', move);
                    window.removeEventListener('mouseup', up);
                    window.removeEventListener('touchend', up);
                };
                window.addEventListener('mousemove', move);
                window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('mouseup', up);
                window.addEventListener('touchend', up);
            }

            // 缩放
            if (resizeHandle) {
                resizeHandle.addEventListener('touchstart', resizeStart);
                resizeHandle.addEventListener('mousedown', resizeStart);

                function resizeStart(e) {
                    e.preventDefault(); e.stopPropagation();
                    if(drawingMode) setDrawingMode(null, null);

                    const p = e.touches ? e.touches[0] : e;
                    const startX = p.clientX;
                    
                    let content = el.querySelector('.item-content');
                    if(content.firstElementChild) content = content.firstElementChild;

                    const style = window.getComputedStyle(content);
                    const isText = content.classList.contains('custom-input-text') || content.classList.contains('sticker-text');
                    const startVal = isText ? parseFloat(style.fontSize) : parseFloat(content.style.width || content.offsetWidth);

                    const rMove = (em) => {
                        const pm = em.touches ? em.touches[0] : em;
                        const diff = pm.clientX - startX;
                        if(isText) {
                            let s = startVal + diff/2;
                            if(s < 12) s = 12;
                            content.style.fontSize = s + 'px';
                        } else {
                            let s = startVal + diff;
                            if(s < 20) s = 20;
                            content.style.width = s + 'px';
                            // 爆炸框中心扩大
                            if (content.className.includes('shape-exp')) {
                                content.style.height = (s * 0.75) + 'px';
                            } else if (content.className.includes('shape-line')) {
                                // 线条只变宽
                            } else {
                                // 矩形等
                                content.style.height = (parseFloat(content.style.height) + diff) + 'px';
                            }
                        }
                    };
                    const rUp = () => {
                        window.removeEventListener('mousemove', rMove);
                        window.removeEventListener('touchmove', rMove);
                        window.removeEventListener('mouseup', rUp);
                        window.removeEventListener('touchend', rUp);
                    };
                    window.addEventListener('mousemove', rMove);
                    window.addEventListener('touchmove', rMove, {passive: false});
                    window.addEventListener('mouseup', rUp);
                    window.addEventListener('touchend', rUp);
                }
            }

            // 旋转
            if (rotateHandle) {
                rotateHandle.addEventListener('touchstart', rotateStart);
                rotateHandle.addEventListener('mousedown', rotateStart);

                function rotateStart(e) {
                    e.preventDefault(); e.stopPropagation();
                    if(drawingMode) setDrawingMode(null, null);

                    const rect = el.getBoundingClientRect();
                    const center = {
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2
                    };

                    const rotMove = (em) => {
                        const pm = em.touches ? em.touches[0] : em;
                        const angle = Math.atan2(pm.clientY - center.y, pm.clientX - center.x);
                        const deg = angle * (180 / Math.PI) + 90;
                        el.style.transform = `rotate(${deg}deg)`;
                    };
                    const rotUp = () => {
                        window.removeEventListener('mousemove', rotMove);
                        window.removeEventListener('touchmove', rotMove);
                        window.removeEventListener('mouseup', rotUp);
                        window.removeEventListener('touchend', rotUp);
                    };
                    window.addEventListener('mousemove', rotMove);
                    window.addEventListener('touchmove', rotMove, {passive: false});
                    window.addEventListener('mouseup', rotUp);
                    window.addEventListener('touchend', rotUp);
                }
            }
        }

        // --- 绘图 (红框/爆炸/色块/线条) ---
        function setDrawingMode(mode, btn) {
            if(drawingMode === mode) {
                drawingMode = null;
                document.getElementById('drawOverlay').style.display = 'none';
                if(btn) btn.classList.remove('tool-active');
                return;
            }

            drawingMode = mode;
            const overlay = document.getElementById('drawOverlay');
            
            if (mode) {
                overlay.style.display = 'block';
                deselectAllItems();
            } else {
                overlay.style.display = 'none';
            }
            
            document.querySelectorAll('.flex.gap-2 button').forEach(b => b.classList.remove('tool-active'));
            if(btn && mode) btn.classList.add('tool-active');
        }

        const overlay = document.getElementById('drawOverlay');
        let dStartX, dStartY, tempDrawingEl;

        overlay.addEventListener('mousedown', dStart);
        overlay.addEventListener('touchstart', dStart);

        function dStart(e) {
            e.preventDefault();
            const p = e.touches ? e.touches[0] : e;
            const rect = overlay.getBoundingClientRect();
            dStartX = p.clientX - rect.left;
            dStartY = p.clientY - rect.top;
            
            tempDrawingEl = document.createElement('div');
            tempDrawingEl.className = 'temp-drawing-shape';
            tempDrawingEl.style.left = dStartX + 'px';
            tempDrawingEl.style.top = dStartY + 'px';
            
            if(drawingMode === 'rect') {
                tempDrawingEl.style.border = `4px solid ${drawingColor}`;
                tempDrawingEl.style.borderRadius = '12px';
            } else if (drawingMode === 'fillRect') {
                tempDrawingEl.style.backgroundColor = drawingColor;
                tempDrawingEl.style.borderRadius = '12px';
            } else if (drawingMode === 'line') {
                tempDrawingEl.style.borderBottom = `6px solid ${drawingColor}`;
                tempDrawingEl.style.height = '6px';
            } else if (drawingMode === 'explosion') {
                const encoded = encodeURIComponent(drawingColor);
                tempDrawingEl.style.backgroundImage = `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 150' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10,75 L30,60 L20,40 L50,45 L60,20 L80,40 L100,10 L120,40 L140,20 L150,45 L180,40 L170,60 L190,75 L170,90 L180,110 L150,105 L140,130 L120,110 L100,140 L80,110 L60,130 L50,105 L20,110 L30,90 Z' fill='none' stroke='${encoded}' stroke-width='4' stroke-linejoin='round'/%3E%3C/svg%3E")`;
                tempDrawingEl.style.backgroundSize = '100% 100%';
            }
            document.getElementById('workStage').appendChild(tempDrawingEl);

            const move = (em) => {
                em.preventDefault();
                const pm = em.touches ? em.touches[0] : em;
                const dEndX = pm.clientX - rect.left;
                const dEndY = pm.clientY - rect.top;
                
                let x, y, w, h;
                
                if (drawingMode === 'line') {
                    w = Math.abs(dEndX - dStartX);
                    h = 6; 
                    x = Math.min(dStartX, dEndX);
                    y = dStartY; 
                } else if(drawingMode === 'explosion') {
                    w = Math.abs(dEndX - dStartX) * 2;
                    h = Math.abs(dEndY - dStartY) * 2;
                    x = dStartX - w/2;
                    y = dStartY - h/2;
                } else {
                    w = Math.abs(dEndX - dStartX);
                    h = Math.abs(dEndY - dStartY);
                    x = Math.min(dStartX, dEndX);
                    y = Math.min(dStartY, dEndY);
                }
                
                tempDrawingEl.style.width = w + 'px';
                tempDrawingEl.style.height = h + 'px';
                tempDrawingEl.style.left = x + 'px';
                tempDrawingEl.style.top = y + 'px';
            }

            const up = (em) => {
                const pm = em.changedTouches ? em.changedTouches[0] : em;
                const dEndX = pm.clientX - rect.left;
                const dEndY = pm.clientY - rect.top;
                
                const finalW = parseFloat(tempDrawingEl.style.width);
                const finalH = parseFloat(tempDrawingEl.style.height);
                const finalX = parseFloat(tempDrawingEl.style.left);
                const finalY = parseFloat(tempDrawingEl.style.top);
                tempDrawingEl.remove();
                
                if(finalW > 10) { 
                    addShape(finalX, finalY, finalW, finalH, drawingMode);
                }
                
                window.removeEventListener('mousemove', move);
                window.removeEventListener('touchmove', move);
                window.removeEventListener('mouseup', up);
                window.removeEventListener('touchend', up);
            };
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('mouseup', up);
            window.addEventListener('touchend', up);
        }

        function addShape(x, y, w, h, type) {
            const content = document.createElement('div');
            content.className = 'item-content';
            const shape = document.createElement('div');
            shape.style.width = w + 'px';
            shape.style.height = h + 'px';
            
            if (type === 'rect') {
                shape.className = 'shape-rect';
                shape.style.borderColor = drawingColor;
            } else if (type === 'fillRect') {
                shape.className = 'shape-fill-rect';
                shape.style.backgroundColor = drawingColor;
            } else if (type === 'line') {
                shape.className = 'shape-line';
                shape.style.borderBottomColor = drawingColor;
            } else {
                shape.className = 'shape-exp';
                const encoded = encodeURIComponent(drawingColor);
                shape.style.backgroundImage = `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 150' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10,75 L30,60 L20,40 L50,45 L60,20 L80,40 L100,10 L120,40 L140,20 L150,45 L180,40 L170,60 L190,75 L170,90 L180,110 L150,105 L140,130 L120,110 L100,140 L80,110 L60,130 L50,105 L20,110 L30,90 Z' fill='none' stroke='${encoded}' stroke-width='4' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
            content.appendChild(shape);
            const el = createItem(content, 'shape');
            el.style.left = x + 'px'; el.style.top = y + 'px';
        }

        // --- 工具 ---
        function undo() {
            const last = historyStack.pop();
            if(last) last.remove();
        }
        function clearAllItems() {
            document.querySelectorAll('.interactive-item').forEach(el => el.remove());
            historyStack = [];
        }

        // --- 核心：合成 (原地快照法) ---
        function finishAnnotation() {
            deselectAllItems(); // 隐藏把手
            
            const stage = document.getElementById('workStage');
            
            html2canvas(stage, {
                backgroundColor: null,
                scale: 2,
                logging: false
            }).then(canvas => {
                const finalUrl = canvas.toDataURL('image/jpeg', 0.9);
                
                const target = document.getElementById(currentTargetId);
                target.src = finalUrl;
                target.classList.remove('hidden');
                
                if(currentTargetId === 'mainImg') {
                    document.getElementById('mainImgPlaceholder').classList.add('hidden');
                    target.parentElement.classList.remove('border-2', 'border-dashed');
                } else if(currentTargetId === 'logoImg') {
                    target.style.maxHeight = '48px'; target.style.width = 'auto';
                }
                
                closeEditor();
            }).catch(err => {
                console.error("合成失败:", err);
                alert("合成图片失败");
            });
        }

        // --- 下载 ---
        function downloadCard() {
            const card = document.getElementById('capture-area');
            const text = document.getElementById('mainText');
            // 锁定高度防抖动
            const h = text.offsetHeight;
            text.style.height = h + 'px';
            text.style.overflow = 'hidden';

            const scrollPos = window.scrollY;
            window.scrollTo(0, 0);

            html2canvas(card, {
                scale: 3,
                useCORS: true,
                backgroundColor: null,
                scrollX: 0,
                scrollY: 0
            }).then(canvas => {
                text.style.height = ''; 
                window.scrollTo(0, scrollPos);
                
                const url = canvas.toDataURL('image/jpeg', 0.95);
                if(/Mobi|Android/i.test(navigator.userAgent)) {
                    document.getElementById('resultImg').src = url;
                    document.getElementById('resultModal').style.display = 'flex';
                } else {
                    const a = document.createElement('a');
                    a.download = '教育卡片.jpg';
                    a.href = url;
                    a.click();
                }
            }).catch(err => {
                console.error(err);
                text.style.height = '';
                window.scrollTo(0, scrollPos);
            });
        }
    </script>
</body>
</html>