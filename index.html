<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教育卡片生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 自定义字体定义 */
        @font-face {
            font-family: 'Microsoft YaHei';
            src: local('Microsoft YaHei'), local('PingFang SC');
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除点击高亮 */
            overscroll-behavior: none; /* 防止下拉刷新干扰拖拽 */
        }

        /* 天蓝到藏青色渐变背景 */
        .card-container {
            background: linear-gradient(180deg, #87CEEB 0%, rgb(87, 38, 125) 100%);
        }
        
        /* 统一的大块雾化玻璃效果 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 1rem;
        }

        /* 装饰背景 */
        .wave-decor {
            position: absolute;
            top: 40%;
            left: -10%;
            width: 120%;
            height: 60%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(-15deg);
            z-index: 0;
            pointer-events: none;
        }

        /* 字体样式：微软雅黑 + 斜体 + 加粗 */
        .custom-text-style {
            font-family: 'Microsoft YaHei', sans-serif;
            font-style: italic;
            font-weight: bold;
        }

        input[type="file"] {
            display: none;
        }

        .content-layer {
            position: relative;
            z-index: 10;
        }

        /* 修正截图偏移 */
        #capture-area {
            overflow: hidden; 
            box-sizing: border-box;
            user-select: none; /* 防止拖拽时选中文字 */
        }

        /* 结果模态框 */
        #resultModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            touch-action: none;
        }

        #resultImg {
            -webkit-touch-callout: default !important;
            -webkit-user-select: none;
            user-select: none;
            pointer-events: auto !important;
            touch-action: auto;
        }
        
        /* 刷新按钮样式 */
        .refresh-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .text-wrapper:hover .refresh-btn {
            opacity: 1;
        }

        /* --- 新增样式：标注工具 --- */
        
        /* 贴纸样式 */
        .sticker {
            position: absolute;
            font-size: 3rem;
            cursor: move;
            z-index: 30; /* 确保在图片和文字之上 */
            user-select: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            touch-action: none; /* 关键：防止触摸时滚动屏幕 */
            transition: transform 0.1s;
        }
        .sticker:active {
            transform: scale(1.1);
        }

        /* 红框样式 */
        .red-box {
            position: absolute;
            border: 3px solid #ff0000;
            z-index: 30;
            pointer-events: auto; /* 允许点击以删除 */
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }
        .red-box:hover {
            background-color: rgba(255, 0, 0, 0.1); /* 悬停提示可交互 */
        }

        /* 标注层 (存放贴纸和红框) */
        #annotation-layer {
            position: absolute;
            inset: 0;
            z-index: 30;
            pointer-events: none; /* 让点击事件穿透到下层文字编辑，除非点到sticker/box */
        }
        #annotation-layer > * {
            pointer-events: auto; /* 子元素恢复交互 */
        }

        /* 画图覆盖层 (画红框时开启) */
        #drawing-overlay {
            position: absolute;
            inset: 0;
            z-index: 40; /* 最高层级，覆盖文字编辑 */
            cursor: crosshair;
            background-color: rgba(0,0,0,0.05); /* 微弱背景提示进入模式 */
            display: none; /* 默认隐藏 */
            touch-action: none;
        }
        
        /* 工具栏样式 */
        .toolbar-btn {
            transition: all 0.2s;
        }
        .toolbar-btn:active {
            transform: scale(0.95);
        }
        .toolbar-btn.active {
            background-color: #fee2e2;
            color: #ef4444;
            border-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4">

    <!-- 顶部提示 -->
    <div class="mb-2 text-center text-gray-600 max-w-lg">
        <h1 class="text-2xl font-bold mb-1 text-gray-800">教育卡片生成器</h1>
        <p class="text-xs text-gray-500">双击文本可编辑 | 拖动贴纸遮挡隐私</p>
    </div>

    <!-- 工具栏区域 (新增) -->
    <div class="w-full max-w-[480px] bg-white rounded-xl shadow-sm p-3 mb-4 flex flex-col gap-3">
        <!-- 贴纸选择 -->
        <div class="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
            <span class="text-xs font-bold text-gray-500 whitespace-nowrap">遮挡贴纸:</span>
            <div class="flex gap-2">
                <button onclick="addSticker('🌸')" class="text-2xl hover:scale-110 transition toolbar-btn">🌸</button>
                <button onclick="addSticker('🌹')" class="text-2xl hover:scale-110 transition toolbar-btn">🌹</button>
                <button onclick="addSticker('🌻')" class="text-2xl hover:scale-110 transition toolbar-btn">🌻</button>
                <button onclick="addSticker('🌷')" class="text-2xl hover:scale-110 transition toolbar-btn">🌷</button>
                <button onclick="addSticker('🍀')" class="text-2xl hover:scale-110 transition toolbar-btn">🍀</button>
                <button onclick="addSticker('🍄')" class="text-2xl hover:scale-110 transition toolbar-btn">🍄</button>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex gap-3 border-t pt-3">
            <button id="drawBtn" onclick="toggleDrawingMode()" class="flex-1 border border-gray-300 rounded-lg py-2 text-sm font-bold text-gray-700 flex items-center justify-center gap-1 hover:bg-gray-50 toolbar-btn">
                <span id="drawBtnIcon">✏️</span>
                <span id="drawBtnText">画红框 (关)</span>
            </button>
            <button onclick="clearAnnotations()" class="flex-1 border border-gray-300 rounded-lg py-2 text-sm font-bold text-gray-700 flex items-center justify-center gap-1 hover:bg-gray-50 toolbar-btn">
                🗑️ 清空标记
            </button>
        </div>
        <p class="text-[10px] text-gray-400 text-center">提示：所有标记(贴纸/红框)均可双击删除</p>
    </div>

    <!-- 卡片区域 -->
    <div id="capture-area" class="card-container rounded-[2rem] shadow-2xl w-full max-w-[480px] relative flex flex-col p-5 sm:p-6 overflow-hidden mx-auto">
        
        <!-- 背景装饰 -->
        <div class="wave-decor"></div>

        <!-- 标注层 (贴纸和红框在这里) -->
        <div id="annotation-layer"></div>

        <!-- 画图覆盖层 (仅在画红框模式下显示) -->
        <div id="drawing-overlay"></div>

        <div class="content-layer flex flex-col h-full pointer-events-none"> <!-- content-layer pointer-events-none 让点击穿透到 annotation-layer -->
            
            <!-- 统一的玻璃面板容器 -->
            <div class="glass-panel flex flex-col p-4 sm:p-5 mb-5 sm:mb-6 pointer-events-auto"> <!-- 恢复子元素交互 -->
                
                <!-- 1. 顶部栏：Logo + 星星 -->
                <div class="flex justify-between items-start mb-3 sm:mb-4 border-b border-white/10 pb-3">
                    <div class="relative group cursor-pointer mr-4 flex-shrink-0" onclick="document.getElementById('logoInput').click()">
                        <img id="logoImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60' fill='none' stroke='%23ffffff' stroke-opacity='0.5' stroke-width='2' stroke-dasharray='4'%3E%3Ctext x='100' y='35' font-size='14' text-anchor='middle' fill='%23ffffff' fill-opacity='0.8'%3ELOGO区域%3C/text%3E%3C/svg%3E" 
                             class="h-8 sm:h-10 w-auto object-contain block" alt="Logo">
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white text-xs rounded transition-all">替换</div>
                        <input type="file" id="logoInput" accept="image/*" onchange="handleImageUpload(this, 'logoImg')">
                    </div>

                    <div class="flex space-x-1 pt-1">
                        <span class="text-yellow-400 text-base sm:text-lg">★</span>
                        <span class="text-yellow-400 text-base sm:text-lg">★</span>
                        <span class="text-yellow-400 text-base sm:text-lg">★</span>
                        <span class="text-yellow-400 text-base sm:text-lg">★</span>
                        <span class="text-yellow-400 text-base sm:text-lg">★</span>
                    </div>
                </div>

                <!-- 2. 中间内容 -->
                <div class="flex flex-col mb-3 sm:mb-4">
                    <div class="mb-3 sm:mb-4 relative text-wrapper group">
                        <p id="mainText" contenteditable="true" 
                           class="custom-text-style text-xl sm:text-2xl leading-relaxed text-white p-2 border border-transparent hover:border-white/30 rounded transition-colors outline-none cursor-text drop-shadow-sm pr-8">
                           "双击文字可以编辑 ，每次都需要手动上传 logo，图片文字替换完成以后点击下载按钮下载，如果下载不了请切换浏览器，如 edge 等，"
                        </p>
                        <button onclick="changeQuote()" data-html2canvas-ignore="true" class="refresh-btn absolute bottom-2 right-2 p-1.5 rounded-full bg-white/20 hover:bg-white/40 text-white backdrop-blur-sm transition-all" title="换一句">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                    </div>

                    <div class="w-full relative group cursor-pointer overflow-hidden rounded-lg bg-black/10" onclick="if(!isDrawingMode) document.getElementById('mainImageInput').click()">
                        <div class="w-full h-full flex items-center justify-center border-2 border-dashed border-white/30 hover:border-white/60 transition-all relative min-h-[200px] sm:min-h-[220px]">
                            <img id="mainImg" src="" class="w-full h-auto object-cover hidden relative z-10" alt="主要图片">
                            <div id="mainImgPlaceholder" class="text-white/80 text-center py-10 px-4 absolute z-0 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full">
                                <svg class="w-10 h-10 mx-auto mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <p class="text-sm">点击上传图片</p>
                            </div>
                        </div>
                        <input type="file" id="mainImageInput" accept="image/*" onchange="handleMainImageUpload(this)">
                    </div>
                </div>

                <!-- 3. 底部栏 -->
                <div class="flex items-center pt-3 border-t border-white/10">
                    <div class="relative cursor-pointer shrink-0" onclick="if(!isDrawingMode) document.getElementById('avatarInput').click()">
                        <div id="avatarContainer" class="w-12 h-12 rounded-full bg-white/20 border border-white/40 overflow-hidden flex items-center justify-center shadow-inner backdrop-blur-md">
                            <img id="avatarImg" src="" class="w-full h-full object-cover">
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(this)">
                    </div>
                    <div class="ml-3 flex flex-col justify-center text-white">
                        <span id="parentName" contenteditable="true" class="text-base font-bold border-b border-transparent hover:border-white/50 outline-none leading-tight pb-0.5">家长姓名</span>
                        <span contenteditable="true" class="text-xs opacity-80 border-b border-transparent hover:border-white/50 outline-none mt-0.5">三年级二班</span>
                    </div>
                    <div class="ml-auto opacity-30 text-white text-3xl sm:text-4xl font-serif leading-none select-none">”</div>
                </div>
            </div>

            <!-- 底部 Slogan -->
            <div class="mt-auto text-center pb-2 pointer-events-auto">
                <h2 class="text-white text-xs sm:text-sm font-medium font-sans tracking-widest opacity-80 drop-shadow-md">
                    做有温度的教育 &nbsp;&nbsp;&nbsp; 做有梦想的教育
                </h2>
            </div>
        </div>
    </div>

    <!-- 保存按钮 -->
    <button onclick="downloadCard()" class="mt-6 mb-10 bg-slate-700 hover:bg-slate-800 text-white font-medium py-3 px-8 rounded-full shadow-lg transition-all hover:scale-105 active:scale-95 flex items-center gap-2 text-sm z-50">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
        保存图片
    </button>

    <!-- 结果预览模态框 -->
    <div id="resultModal" onclick="closeModal()">
        <div class="text-white text-center mb-4 relative z-50" onclick="event.stopPropagation()">
            <p class="text-lg font-bold">图片已生成</p>
            <p class="text-sm opacity-80 mt-1">请长按下方图片保存到相册</p>
        </div>
        <img id="resultImg" class="max-w-[90%] max-h-[75%] rounded-lg shadow-2xl border-2 border-white/20 relative z-50" alt="Result">
        <button onclick="closeModal()" class="mt-6 bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-full text-sm backdrop-blur-sm transition-colors relative z-50" onclick="event.stopPropagation()">关闭窗口</button>
    </div>

    <script>
        // --- 1. 基础功能逻辑 ---
        
        // 励志语录库 (部分示例，保留原有功能)
        const quotes = [
            "天道酬勤，厚积薄发", "星光不问赶路人，时光不负有心人。", "学习不仅仅是为了那一张试卷，而是为了让你拥有选择世界的权利。", 
            "不要假装努力，结果不会陪你演戏。", "你背不下来的书，总有人能背下来。", "种一棵树最好的时间是十年前，其次是现在。",
            "将来的你，一定会感谢现在拼命努力的自己。", "不积跬步，无以至千里。", "乾坤未定，你我皆是黑马。",
            "努力不一定成功，但不努力一定很轻松？不，不努力的轻松是暂时的。", "每天进步一点点，一年之后就是巨大的飞跃。"
        ];

        function changeQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const mainText = document.getElementById('mainText');
            mainText.innerText = `"${quotes[randomIndex]}"`;
        }
        window.addEventListener('load', changeQuote);

        // 植物头像 (Base64转换逻辑)
        const plantAvatars = [
            '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#aaddaa"/><path d="M50 20 Q30 40 50 60 Q70 40 50 20 M50 60 L50 80 M40 70 L60 70" stroke="#558855" stroke-width="4" fill="none"/></svg>', 
            '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#ccccff"/><path d="M50 80 L50 40 M30 50 Q50 30 70 50" stroke="#6666aa" stroke-width="4" fill="none"/><circle cx="50" cy="35" r="10" fill="#8888cc"/></svg>',
            '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#ffddaa"/><rect x="45" y="50" width="10" height="30" fill="#885522"/><circle cx="50" cy="40" r="20" fill="#44aa44"/></svg>'
        ];
        function svgToPngDataUrl(svgString, callback) {
            const img = new Image();
            const base64 = window.btoa(unescape(encodeURIComponent(svgString)));
            img.src = 'data:image/svg+xml;base64,' + base64;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                canvas.getContext('2d').drawImage(img, 0, 0);
                callback(canvas.toDataURL('image/png'));
            };
        }
        function setRandomAvatar() {
            const idx = Math.floor(Math.random() * plantAvatars.length);
            svgToPngDataUrl(plantAvatars[idx], function(url) {
                document.getElementById('avatarImg').src = url;
            });
        }
        setRandomAvatar();

        // 图片上传通用处理
        function handleImageUpload(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    if(imgId === 'logoImg') {
                        img.classList.remove('h-8', 'sm:h-10');
                        img.style.maxHeight = "48px";
                        img.style.width = "auto";
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function handleMainImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('mainImg');
                    const placeholder = document.getElementById('mainImgPlaceholder');
                    const container = img.parentElement;
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    container.classList.remove('border-2', 'border-dashed', 'border-white/30', 'min-h-[200px]', 'sm:min-h-[220px]');
                    container.style.height = 'auto';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('avatarImg').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 2. 新增功能：贴纸与标注 ---

        const annotationLayer = document.getElementById('annotation-layer');
        let isDrawingMode = false;

        // 添加贴纸
        function addSticker(emoji) {
            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            sticker.innerText = emoji;
            // 默认位置：居中
            sticker.style.left = '50%';
            sticker.style.top = '50%';
            sticker.style.transform = 'translate(-50%, -50%)';
            
            // 双击删除
            sticker.addEventListener('dblclick', function() {
                annotationLayer.removeChild(sticker);
            });

            // 拖拽逻辑
            makeDraggable(sticker);
            
            annotationLayer.appendChild(sticker);
        }

        // 元素拖拽核心逻辑 (兼容 PC 和 Mobile)
        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            function startDrag(e) {
                if (isDrawingMode) return; // 画图模式下禁用拖拽
                isDragging = true;
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                startX = clientX;
                startY = clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                
                // 暂时移除 transform 以便计算绝对位置，防止跳动
                el.style.transform = 'none';
                el.style.left = initialLeft + 'px';
                el.style.top = initialTop + 'px';

                e.preventDefault(); // 防止触摸滚动
            }

            function drag(e) {
                if (!isDragging) return;
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                const dx = clientX - startX;
                const dy = clientY - startY;

                el.style.left = (initialLeft + dx) + 'px';
                el.style.top = (initialTop + dy) + 'px';
                
                e.preventDefault();
            }

            function stopDrag() {
                isDragging = false;
            }

            el.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', stopDrag);

            el.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('touchmove', drag, {passive: false});
            window.addEventListener('touchend', stopDrag);
        }

        // 画红框逻辑
        const drawingOverlay = document.getElementById('drawing-overlay');
        const drawBtn = document.getElementById('drawBtn');
        let isDrawing = false;
        let startX, startY;
        let currentBox = null;

        function toggleDrawingMode() {
            isDrawingMode = !isDrawingMode;
            if (isDrawingMode) {
                drawBtn.classList.add('active');
                document.getElementById('drawBtnText').innerText = "画红框 (开)";
                drawingOverlay.style.display = 'block';
            } else {
                drawBtn.classList.remove('active');
                document.getElementById('drawBtnText').innerText = "画红框 (关)";
                drawingOverlay.style.display = 'none';
            }
        }

        function startBox(e) {
            isDrawing = true;
            const rect = drawingOverlay.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            startX = clientX - rect.left;
            startY = clientY - rect.top;

            currentBox = document.createElement('div');
            currentBox.className = 'red-box';
            currentBox.style.left = startX + 'px';
            currentBox.style.top = startY + 'px';
            currentBox.style.width = '0px';
            currentBox.style.height = '0px';
            
            // 双击红框删除
            currentBox.addEventListener('dblclick', function() {
                annotationLayer.removeChild(this);
            });

            annotationLayer.appendChild(currentBox);
            e.preventDefault();
        }

        function drawBox(e) {
            if (!isDrawing || !currentBox) return;
            const rect = drawingOverlay.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            const currentX = clientX - rect.left;
            const currentY = clientY - rect.top;

            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const left = Math.min(currentX, startX);
            const top = Math.min(currentY, startY);

            currentBox.style.width = width + 'px';
            currentBox.style.height = height + 'px';
            currentBox.style.left = left + 'px';
            currentBox.style.top = top + 'px';
            
            e.preventDefault();
        }

        function stopBox() {
            isDrawing = false;
            currentBox = null;
        }

        drawingOverlay.addEventListener('mousedown', startBox);
        drawingOverlay.addEventListener('mousemove', drawBox);
        drawingOverlay.addEventListener('mouseup', stopBox);
        
        drawingOverlay.addEventListener('touchstart', startBox, {passive: false});
        drawingOverlay.addEventListener('touchmove', drawBox, {passive: false});
        drawingOverlay.addEventListener('touchend', stopBox);

        // 清空标记
        function clearAnnotations() {
            annotationLayer.innerHTML = '';
        }

        // --- 3. 生成图片 ---
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function downloadCard() {
            // 如果处于画图模式，先自动关闭，以免蒙版挡住图片
            if(isDrawingMode) toggleDrawingMode();

            const element = document.getElementById("capture-area");
            const btn = document.querySelector('button[onclick="downloadCard()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '正在生成...';
            btn.disabled = true;

            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const scale = isMobile ? 2 : 3;

            html2canvas(element, {
                scale: scale,
                useCORS: true,
                backgroundColor: null,
                logging: false,
                allowTaint: true,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight,
                ignoreElements: (el) => el.hasAttribute('data-html2canvas-ignore') || el.id === 'drawing-overlay'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                if (isMobile) {
                    const resultImg = document.getElementById('resultImg');
                    resultImg.src = imgData;
                    document.getElementById('resultModal').style.display = 'flex';
                } else {
                    const link = document.createElement('a');
                    link.download = '教育卡片_' + Date.now() + '.jpg';
                    link.href = imgData;
                    link.click();
                }
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error("Error:", err);
                alert("生成出错，请重试");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>